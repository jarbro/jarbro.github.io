<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Shoretel No Service Behind Fortigate Firewall</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="http://blog.jarbro.com/favicon.ico">

    <link rel="stylesheet" type="text/css" href="//blog.jarbro.com/themes/casper/assets/css/screen.css?v=1498168189465" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />

    <link rel="canonical" href="http://blog.jarbro.com/2017/03/21/Shoretel-No-Service-Behind-Fortigate-Firewall.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="blog &lt;dot&gt;" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Shoretel No Service Behind Fortigate Firewall" />
    <meta property="og:description" content="Got a call this morning reporting there was an issue with our phones this morning in our satellite office. The dreaded NO SERVICE message on the phones. After doing all the normal diagnostics and checks and resetting phones to factory, they still did not want to cooperate. Digging deeper I" />
    <meta property="og:url" content="http://blog.jarbro.com/2017/03/21/Shoretel-No-Service-Behind-Fortigate-Firewall.html" />
    <meta property="og:image" content="http://i.imgur.com/CPpAXvl.png" />
    <meta property="article:published_time" content="2017-03-21T00:00:00.000Z" />
    <meta property="article:tag" content="IPSEC" />
    <meta property="article:tag" content=" FORTIGATE" />
    <meta property="article:tag" content=" SHORETEL" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Shoretel No Service Behind Fortigate Firewall" />
    <meta name="twitter:description" content="Got a call this morning reporting there was an issue with our phones this morning in our satellite office. The dreaded NO SERVICE message on the phones. After doing all the normal diagnostics and checks and resetting phones to factory, they still did not want to cooperate. Digging deeper I" />
    <meta name="twitter:url" content="http://blog.jarbro.com/2017/03/21/Shoretel-No-Service-Behind-Fortigate-Firewall.html" />
    <meta name="twitter:image:src" content="http://i.imgur.com/CPpAXvl.png" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "blog <dot>",
    "author": {
        "@type": "Person",
        "name": "Jared Brodsky",
        "image": "https://avatars1.githubusercontent.com/u/3271673?v=3",
        "url": "http://blog.jarbro.com/author/jarbro/",
        "sameAs": "blog.jarbro.com",
        "description": "nothing to see here, move along."
    },
    "headline": "Shoretel No Service Behind Fortigate Firewall",
    "url": "http://blog.jarbro.com/2017/03/21/Shoretel-No-Service-Behind-Fortigate-Firewall.html",
    "datePublished": "2017-03-21T00:00:00.000Z",
    "image": "http://i.imgur.com/CPpAXvl.png",
    "keywords": "IPSEC,  FORTIGATE,  SHORETEL",
    "description": "Got a call this morning reporting there was an issue with our phones this morning in our satellite office. The dreaded NO SERVICE message on the phones. After doing all the normal diagnostics and checks and resetting phones to factory, they still did not want to cooperate. Digging deeper I"
}
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="blog &lt;dot&gt;" href="http://blog.jarbro.com/rss/" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/styles/atom-one-dark.min.css">
</head>
<body class="post-template tag-IPSEC tag-FORTIGATE tag-SHORETEL nav-closed">

    

    <div class="site-wrapper">

        


<header class="main-header post-head " style="background-image: url(http://i.imgur.com/CPpAXvl.png)">
    <nav class="main-nav overlay clearfix">
        
    </nav>
</header>

<main class="content" role="main">
    <article class="post tag-IPSEC tag-FORTIGATE tag-SHORETEL">

        <header class="post-header">
            <h1 class="post-title">Shoretel No Service Behind Fortigate Firewall</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2017-03-21">21 March 2017</time>  on <a href="http://blog.jarbro.com/tag/IPSEC/">IPSEC</a>, <a href="http://blog.jarbro.com/tag/FORTIGATE/"> FORTIGATE</a>, <a href="http://blog.jarbro.com/tag/SHORETEL/"> SHORETEL</a>
            </section>
        </header>

        <section class="post-content">
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Got a call this morning reporting there was an issue with our phones this morning in our satellite office. The dreaded NO SERVICE message on the phones. After doing all the normal diagnostics and checks and resetting phones to factory, they still did not want to cooperate.</p>
</div>
<div class="paragraph">
<p>Digging deeper I ran a packet capture from my Shoretel Switch Diagnostic and Monitoring to get more info.  Upon inspection, I saw the phones sending MGCP Duplicate Requests. The requests never went past the <a href="https://dreamforccie.wordpress.com/2010/08/07/understanding-mgcp-packets-a-brief-overview-and-example-with-debugs/">AUEP</a> stage of the negotiation. Now I at least know where to look. For some reason the phones were never getting the expected 200 code preventing it from booting normally.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://i.imgur.com/LO5Od0Z.png" alt="LO5Od0Z.png">
</div>
</div>
<div class="paragraph">
<p>Requests from the remote site looked like they were going out ok, however when looking at the response from my home office I noticed something odd, it was trying to route packets destined for the IPSEC tunnel to the phones over my WAN interface! <a href="http://i3.kym-cdn.com/entries/icons/original/000/001/692/omgwtfbbq2.jpg">OMGWTFBBQ</a>!!</p>
</div>
<div class="paragraph">
<p>To figure out if you are affected by the same issue, run the following commands on each end of your IPSEC tunnel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-numbered" data-lang="numbered">&gt;diag sys session filter dst &lt;your phone or switch IP&gt;
&gt;diag sys session list
session info: proto=17 proto_state=00 duration=59663 expire=109 timeout=0 flags=00000000 sockflag=00000000 sockport=0 av_idx=0 use=4
origin-shaper=
reply-shaper=
per_ip_shaper=
ha_id=0 policy_dir=0 tunnel=/ vlan_cos=0/255
state=log may_dirty none
statistic(bytes/packets/allow_err): org=768551/7929/1 reply=0/0/0 tuples=3
tx speed(Bps/kbps): 13/0 rx speed(Bps/kbps): 0/0
orgin-&gt;sink: org pre-&gt;post, reply pre-&gt;post dev=37-&gt;7/7-&gt;37 gwy=x.x.WAN.GW/0.0.0.0  &lt;*&gt;
hook=post dir=org act=snat 192.168.0.4:2727-192.168.1.100:2427(x.x.x.WAN:63143) &lt;*&gt;
hook=pre dir=reply act=dnat 192.168.1.100:2427-&gt;.x.x.WAN:63143(192.168.0.4:2727)
hook=post dir=reply act=noop 192.168.1.100:2427-&gt;192.168.0.4:2727(0.0.0.0:0)
src_mac=00:10:49:16:xx:xx
misc=0 policy_id=38 auth_info=0 chk_client_info=0 vd=0
serial=06476ede tos=ff/ff app_list=2004 app=16670 url_cat=0
dd_type=0 dd_mode=0
total session 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>By looking at the the above at <strong>(1)</strong> and <strong>(2)</strong>, you can see that traffic from 192.168.0.4 &#8594; 192.168.1.100 is trying to be routed over the WAN link. This is no good.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_remedy">Remedy</h5>
<div class="paragraph">
<p>To fix this issue, you can do one of two things, you can add a <a href="http://kb.fortinet.com/kb/microsites/search.do?cmd=displayKC&amp;docType=kc&amp;externalId=13842&amp;sliceId=1&amp;docTypeID=DT_KCARTICLE_1_1&amp;dialogID=59571995&amp;stateId=0%200%2059573459">blackhole static route</a> to your config, or you can add a DENY policy to your firewall.</p>
</div>
<div class="paragraph">
<p>In my instance I added a DENY policy which did the trick nicely. (Confirmed this was ok with Fortinet TAC)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-numbered" data-lang="numbered">config firewall policy
edit &lt;policyID&gt;
set name "Block_Shoretel_WAN"
set srcintf "LAN"
set dstintf "wan"
set srcaddr "Shoretel_LAN"
set dstaddr "remote_subnet_1"
set schedule "always"
set service "ALL"
set logtraffic all
next
end</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_the_root_of_the_issue">The Root of the Issue</h5>
<div class="paragraph">
<p>Why did this happen? In my instance, it was due to having two WAN links. At somepoint in the night, while all IT people should be sleeping (cough, cough), the IPSEC tunnel between offices got interrupted and failed over as expected to backup.  Unfortunately, when the the primary link came back online, the FGT was still trying to push IPSEC bound traffic over the backup WAN link for some strange reason (Which it never should have tried to do anyway).  The newly created policy should prevent this from happening in the event the primary goes out for any period of time.</p>
</div>
<div class="paragraph">
<p>Has this happened to you? Have you come up with a better solution or remedy, please share in the comments below.</p>
</div>
</div>
        </section>

        <footer class="post-footer">


            <figure class="author-image">
                <a class="img" href="http://blog.jarbro.com/author/jarbro/" style="background-image: url(https://avatars1.githubusercontent.com/u/3271673?v&#x3D;3)"><span class="hidden">Jared Brodsky's Picture</span></a>
            </figure>

            <section class="author">
                <h4><a href="http://blog.jarbro.com/author/jarbro/">Jared Brodsky</a></h4>

                    <p>nothing to see here, move along.</p>
                <div class="author-meta">
                    <span class="author-location icon-location">I ❤︎ NYC</span>
                    <span class="author-link icon-link"><a href="blog.jarbro.com">blog.jarbro.com</a></span>
                </div>
            </section>


            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="https://twitter.com/intent/tweet?text=Shoretel%20No%20Service%20Behind%20Fortigate%20Firewall&amp;url=http://blog.jarbro.com/"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.jarbro.com/"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://blog.jarbro.com/"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

        </footer>


        <section class="post-comments">
          <div id="disqus_thread"></div>
          <script type="text/javascript">
          var disqus_shortname = 'jarbro'; // required: replace example with your forum shortname
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </section>


    </article>

</main>

<aside class="read-next">
</aside>



        <footer class="site-footer clearfix">
            <section class="copyright"><a href="http://blog.jarbro.com">blog &lt;dot&gt;</a> &copy; 2017</section>
            <section class="poweredby">Proudly published with <a href="http://hubpress.io">HubPress</a></section>
        </footer>

    </div>

    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/highlight.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        hljs.initHighlightingOnLoad();
      </script>
       
    <script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

    <script type="text/javascript" src="//blog.jarbro.com/themes/casper/assets/js/jquery.fitvids.js?v=1498168189465"></script>
    <script type="text/javascript" src="//blog.jarbro.com/themes/casper/assets/js/index.js?v=1498168189465"></script>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-71227-21', 'auto');
    ga('send', 'pageview');

    </script>
</body>
</html>

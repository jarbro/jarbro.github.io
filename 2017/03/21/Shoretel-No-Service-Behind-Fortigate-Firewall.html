<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>Shoretel No Service Behind Fortigate Firewall</title>

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Shoretel No Service Behind Fortigate Firewall">
    <meta name="twitter:description" content="">

    <meta property="og:url" content="http://blog.jarbro.com">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Shoretel No Service Behind Fortigate Firewall">
    <meta property="og:description" content="">
    <meta property="og:site_name" content="blog.jarbro">

    <meta itemprop="name" content="Shoretel No Service Behind Fortigate Firewall">
    <meta itemprop="description" content="">

    <meta name="twitter:site" content="@yourblogtwitter">
    
    <meta name="twitter:creator" content="@yourtwitter">
    
    <meta property="article:author" content="https://www.facebook.com/yourprofile">
    
    <meta property="article:publisher" content="https://www.facebook.com/yourblogprofile">
    
    <meta property="fb:admins" content="">
    
    <meta name="google-site-verification" content="">
    
    <link rel="author" href="https://plus.google.com/yourprofile">
    
    <meta name="theme-color" content="">

    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <link href="/apple-touch-icon-precomposed.png" rel="apple-touch-icon">

    <link href="//fonts.googleapis.com/" rel="dns-prefetch">
    <link href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400&subset=latin,latin-ext" rel="stylesheet">

    <link rel="stylesheet" href="//blog.jarbro.com/themes/ghostium/assets/css/main.min.css?v=1552658566729">
    <link rel="stylesheet" href="//blog.jarbro.com/themes/ghostium/assets/css/asciidoctor-foundation.css?v=1552658566729"/>

    <script type="text/javascript">
      var ga_ua = 'UA-XXXXX-X';
      
      var disqus_shortname = 'example';
      
      var enable_pjax = true;

      // Pace Options
      // ==============
      window.paceOptions = {
        catchupTime: 100,
        minTime: 100,
        elements: false,
        restartOnRequestAfter: 500,
        startOnPageLoad: false
      }

      // Ghostium Globals
      // ==============
      window.GHOSTIUM = {};
      GHOSTIUM.haveGA = typeof ga_ua !== 'undefined' && ga_ua !== 'UA-XXXXX-X';
      GHOSTIUM.haveDisqus = typeof disqus_shortname !== 'undefined' && disqus_shortname !== 'example';
      GHOSTIUM.enablePjax = typeof enable_pjax !== 'undefined' ? enable_pjax : true;
    </script>

    <script src="//blog.jarbro.com/themes/ghostium/assets/js/head-scripts.min.js?v=1552658566729"></script>

    <link rel="canonical" href="http://blog.jarbro.com/2017/03/21/Shoretel-No-Service-Behind-Fortigate-Firewall.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="blog.jarbro" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Shoretel No Service Behind Fortigate Firewall" />
    <meta property="og:description" content="Got a call this morning reporting there was an issue with our phones this morning in our satellite office. The dreaded NO SERVICE message on the phones. After doing all the normal diagnostics and checks and resetting phones to factory, they still did not want to cooperate. Digging deeper I" />
    <meta property="og:url" content="http://blog.jarbro.com/2017/03/21/Shoretel-No-Service-Behind-Fortigate-Firewall.html" />
    <meta property="og:image" content="http://i.imgur.com/CPpAXvl.png" />
    <meta property="article:published_time" content="2017-03-21T00:00:00.000Z" />
    <meta property="article:tag" content="IPSEC" />
    <meta property="article:tag" content="FORTIGATE" />
    <meta property="article:tag" content="SHORETEL" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Shoretel No Service Behind Fortigate Firewall" />
    <meta name="twitter:description" content="Got a call this morning reporting there was an issue with our phones this morning in our satellite office. The dreaded NO SERVICE message on the phones. After doing all the normal diagnostics and checks and resetting phones to factory, they still did not want to cooperate. Digging deeper I" />
    <meta name="twitter:url" content="http://blog.jarbro.com/2017/03/21/Shoretel-No-Service-Behind-Fortigate-Firewall.html" />
    <meta name="twitter:image:src" content="http://i.imgur.com/CPpAXvl.png" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "blog.jarbro",
    "author": {
        "@type": "Person",
        "name": "Jared Brodsky",
        "image": "https://avatars2.githubusercontent.com/u/3271673?v=4",
        "url": "http://blog.jarbro.com/author/jarbro/",
        "sameAs": "blog.jarbro.com",
        "description": "nothing to see here, move along."
    },
    "headline": "Shoretel No Service Behind Fortigate Firewall",
    "url": "http://blog.jarbro.com/2017/03/21/Shoretel-No-Service-Behind-Fortigate-Firewall.html",
    "datePublished": "2017-03-21T00:00:00.000Z",
    "image": "http://i.imgur.com/CPpAXvl.png",
    "keywords": "IPSEC, FORTIGATE, SHORETEL",
    "description": "Got a call this morning reporting there was an issue with our phones this morning in our satellite office. The dreaded NO SERVICE message on the phones. After doing all the normal diagnostics and checks and resetting phones to factory, they still did not want to cooperate. Digging deeper I"
}
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="blog.jarbro" href="http://blog.jarbro.com/rss/" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/themes/prism-okaidia.min.css">
    
        <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
  </head>
  <body class="post-template tag-IPSEC tag-FORTIGATE tag-SHORETEL">

    <button data-action="open-drawer" id="drawer-button" class="drawer-button"><i class="fa fa-bars"></i></button>
    <nav tabindex="-1" class="drawer">
      <div class="drawer-container">
        <!--.drawer-search(role="search")-->
        <ul role="navigation" class="drawer-list">
          
          <li class="drawer-list-item">
            <a href="/" data-pjax>
              <i class="fa fa-home"></i>Home
            </a>
          </li>
          <li class="drawer-list-item">
            <a href="http://blog.jarbro.com/rss/">
              <i class="fa fa-rss"></i>Subscribe to Feed
            </a>
          </li>
          <li class="drawer-list-divider"></li>
          <li class="drawer-list-item drawer-list-title">
            Follow me
          </li>
          
          
          <li class="drawer-list-item">
            <a href="jarbro" title="Twitter" target="_blank">
              <i class="fa fa-twitter"></i>Twitter
            </a>
          </li>
          <li class="drawer-list-item">
            <a href="jarbro" title="Github" target="_blank">
              <i class="fa fa-github"></i>Github
            </a>
          </li>
          <li class="drawer-list-item">
            <a href="jarbro" title="Facebook" target="_blank">
              <i class="fa fa-facebook"></i>Facebook
            </a>
          </li>
          <li class="drawer-list-item">
            <a href="jarbro" title="Instagram" target="_blank">
              <i class="fa fa-instagram"></i>Instagram
            </a>
          </li>
          <li class="drawer-list-item">
            <a href="jaredbrodsky" title="LinkedIn" target="_blank">
              <i class="fa fa-linkedin"></i>LinkedIn
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <div class="drawer-overlay"></div>
    <main id="container" role="main" class="container">
      <div class="surface">
        <div class="surface-container">
          <div data-pjax-container class="content">
            
<section class="wrapper wrapper-post">
  <div class="wrapper-container">
    <article itemscope itemtype="http://schema.org/BlogPosting" role="article" class="post post tag-IPSEC tag-FORTIGATE tag-SHORETEL">
        <section class="post-container">
          <header class="post-header">
            <ul class="post-meta-list">
              <li class="post-meta-item">
                <time datetime="2017-03-21" itemprop="datePublished">
                  2 years ago
                </time>
              </li>
                <li class="post-meta-item">
                    <a itemprop="articleSection" href="/" data-pjax>IPSEC</a>, 
                    <a itemprop="keywords" href="/" data-pjax>FORTIGATE</a>, 
                    <a itemprop="keywords" href="/" data-pjax>SHORETEL</a> 
                </li>
              <li class="post-meta-item">
                <a href="#disqus_thread" data-disqus-identifier="">Comments</a>
              </li>
            </ul>
            <h1 itemprop="name headline" class="post-title"><a href="/" itemprop="url" data-pjax title="Shoretel No Service Behind Fortigate Firewall">Shoretel No Service Behind Fortigate Firewall</a></h1>
            <!--h2 itemprop="about" class="post-subtitle"></h2-->
          </header>
          <aside class="post-side">
            <div class="post-author">
                <a href="blog.jarbro.com" class="post-author-avatar">
                  <img src="https://avatars2.githubusercontent.com/u/3271673?v&#x3D;4" alt="Jared Brodsky">
                </a>
              <div class="post-author-info">
                <a href="blog.jarbro.com" class="post-author-name">
                  Jared Brodsky
                </a>
                <p class="post-author-bio">nothing to see here, move along.</p>
              </div>
            </div>
          </aside>
          <div itemprop="articleBody" class="post-body">
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Got a call this morning reporting there was an issue with our phones this morning in our satellite office. The dreaded NO SERVICE message on the phones. After doing all the normal diagnostics and checks and resetting phones to factory, they still did not want to cooperate.</p>
</div>
<div class="paragraph">
<p>Digging deeper I ran a packet capture from my Shoretel Switch Diagnostic and Monitoring to get more info.  Upon inspection, I saw the phones sending MGCP Duplicate Requests. The requests never went past the <a href="https://dreamforccie.wordpress.com/2010/08/07/understanding-mgcp-packets-a-brief-overview-and-example-with-debugs/">AUEP</a> stage of the negotiation. Now I at least know where to look. For some reason the phones were never getting the expected 200 code preventing it from booting normally.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://i.imgur.com/LO5Od0Z.png" alt="LO5Od0Z">
</div>
</div>
<div class="paragraph">
<p>Requests from the remote site looked like they were going out ok, however when looking at the response from my home office I noticed something odd, it was trying to route packets destined for the IPSEC tunnel to the phones over my WAN interface! <a href="http://i3.kym-cdn.com/entries/icons/original/000/001/692/omgwtfbbq2.jpg">OMGWTFBBQ</a>!!</p>
</div>
<div class="paragraph">
<p>To figure out if you are affected by the same issue, run the following commands on each end of your IPSEC tunnel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-numbered" data-lang="numbered">&gt;diag sys session filter dst &lt;your phone or switch IP&gt;
&gt;diag sys session list
session info: proto=17 proto_state=00 duration=59663 expire=109 timeout=0 flags=00000000 sockflag=00000000 sockport=0 av_idx=0 use=4
origin-shaper=
reply-shaper=
per_ip_shaper=
ha_id=0 policy_dir=0 tunnel=/ vlan_cos=0/255
state=log may_dirty none
statistic(bytes/packets/allow_err): org=768551/7929/1 reply=0/0/0 tuples=3
tx speed(Bps/kbps): 13/0 rx speed(Bps/kbps): 0/0
orgin-&gt;sink: org pre-&gt;post, reply pre-&gt;post dev=37-&gt;7/7-&gt;37 gwy=x.x.WAN.GW/0.0.0.0  &lt;*&gt;
hook=post dir=org act=snat 192.168.0.4:2727-192.168.1.100:2427(x.x.x.WAN:63143) &lt;*&gt;
hook=pre dir=reply act=dnat 192.168.1.100:2427-&gt;.x.x.WAN:63143(192.168.0.4:2727)
hook=post dir=reply act=noop 192.168.1.100:2427-&gt;192.168.0.4:2727(0.0.0.0:0)
src_mac=00:10:49:16:xx:xx
misc=0 policy_id=38 auth_info=0 chk_client_info=0 vd=0
serial=06476ede tos=ff/ff app_list=2004 app=16670 url_cat=0
dd_type=0 dd_mode=0
total session 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>By looking at the the above at <strong>(1)</strong> and <strong>(2)</strong>, you can see that traffic from 192.168.0.4 &#8594; 192.168.1.100 is trying to be routed over the WAN link. This is no good.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_remedy">Remedy</h5>
<div class="paragraph">
<p>To fix this issue, you can do one of two things, you can add a <a href="http://kb.fortinet.com/kb/microsites/search.do?cmd=displayKC&amp;docType=kc&amp;externalId=13842&amp;sliceId=1&amp;docTypeID=DT_KCARTICLE_1_1&amp;dialogID=59571995&amp;stateId=0%200%2059573459">blackhole static route</a> to your config, or you can add a DENY policy to your firewall.</p>
</div>
<div class="paragraph">
<p>In my instance I added a DENY policy which did the trick nicely. (Confirmed this was ok with Fortinet TAC)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-numbered" data-lang="numbered">config firewall policy
edit &lt;policyID&gt;
set name "Block_Shoretel_WAN"
set srcintf "LAN"
set dstintf "wan"
set srcaddr "Shoretel_LAN"
set dstaddr "remote_subnet_1"
set schedule "always"
set service "ALL"
set logtraffic all
next
end</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_the_root_of_the_issue">The Root of the Issue</h5>
<div class="paragraph">
<p>Why did this happen? In my instance, it was due to having two WAN links. At somepoint in the night, while all IT people should be sleeping (cough, cough), the IPSEC tunnel between offices got interrupted and failed over as expected to backup.  Unfortunately, when the the primary link came back online, the FGT was still trying to push IPSEC bound traffic over the backup WAN link for some strange reason (Which it never should have tried to do anyway).  The newly created policy should prevent this from happening in the event the primary goes out for any period of time.</p>
</div>
<div class="paragraph">
<p>Has this happened to you? Have you come up with a better solution or remedy, please share in the comments below.</p>
</div>
</div>
          </div>
          <footer class="post-footer">
            <div itemprop="author" itemscope itemtype="http://schema.org/Person" class="post-author">
                <a href="blog.jarbro.com" class="post-author-avatar">
                  <img itemprop="image" src="https://avatars2.githubusercontent.com/u/3271673?v&#x3D;4" alt="Jared Brodsky">
                </a>
              <div class="post-author-info">
                <h4 class="post-footer-heading">Written By</h4>
                <a href="blog.jarbro.com" itemprop="url" class="post-author-name">
                  <span itemprop="name">Jared Brodsky</span>
                </a>
                <p itemprop="description" class="post-author-bio">nothing to see here, move along.</p>
                  <p class="post-author-location">I ❤︎ NYC</p>
                  <p class="post-author-website">
                    <a href="blog.jarbro.com" rel="nofollow">blog.jarbro.com</a>
                  </p>
                <p class="post-info">
                  <b class="post-info-title">Published on</b>
                  <time class="post-date">March 21, 2017</time>
                </p>
              </div>
            </div>
            <div class="post-social">
              <h4 class="post-footer-heading">Spread the word</h4>
              <a href="#" data-action="share-twitter"><i class="fa fa-fw fa-lg fa-twitter"></i></a>
              <a href="#" data-action="share-facebook"><i class="fa fa-fw fa-lg fa-facebook"></i></a>
              <a href="#" data-action="share-gplus"><i class="fa fa-fw fa-lg fa-google-plus"></i></a>
            </div>
          </footer>
        </section>

      <section class="post-comments">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
        var disqus_shortname = 'jarbro'; // required: replace example with your forum shortname
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </section>

    </article>

    <footer role="contentinfo" class="footer">
      <p><small>© 2019. All Rights Reserved.</small></p>
      <p><small><a href="http://ghostium.oswaldoacauan.com/" target="_blank">Ghostium Theme</a> by <a href="http://twitter.com/oswaldoacauan" target="_blank">@oswaldoacauan</a></small></p>
      <p><small>Proudly published with <a href="https://hubpress.github.io" target="_blank">HubPress</a></small></p>
    </footer>
  </div>
</section>


          </div>
        </div>
      </div>
    </main>


    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/prism.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        // hljs.initHighlightingOnLoad();
      </script>

    <script src="//blog.jarbro.com/themes/ghostium/assets/js/foot-scripts.min.js?v=1552658566729"></script>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-71227-21', 'auto');
    ga('send', 'pageview');

    </script>
  </body>
</html>
